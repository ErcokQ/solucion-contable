<!-- Selector RFC + ZIP -->
<div class="flex gap-4 mb-4">
  <label
    class="cursor-pointer bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700"
  >
    Subir ZIP
    <input
      type="file"
      hidden
      accept=".zip"
      (change)="onZip($any($event.target).files[0])"
    />
  </label>
</div>
<!-- input oculto con template-ref -->
<input
  #fileInput
  type="file"
  hidden
  accept=".xml"
  multiple
  (change)="onFiles($any($event.target).files)"
/>

<!-- Dropzone -->
<div
  class="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover:bg-teal-100/50 transition-colors"
  [class.bg-teal-50]="isDrag()"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave()"
  (drop)="onDrop($event)"
  (click)="fileInput.click()"
>
  <!-- ‚¨ÖÔ∏è  abre selector -->
  <p class="text-gray-600">
    Arrastra XML aqu√≠&nbsp;o
    <span class="text-teal-600 underline">haz clic para buscarlos</span>.
  </p>
</div>

<!-- Tabla pendientes -->
@if (pending().length) {
  <table class="w-full text-sm mt-6">
    <thead>
      <tr>
        <th>Archivo</th>
        <th class="w-40">Progreso</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      @for (p of pending(); track p.file.name; let i = $index) {
        <tr class="border-b h-10">
          <td>{{ p.file.name }}</td>
          <td class="w-40">
            @switch (p.status) {
              @case ("pending") {
                <!-- Pendiente -->
                <span class="text-gray-500">Listo&nbsp;para&nbsp;subir</span>
              }
              @case ("uploading") {
                <!-- Subiendo -->
                <div class="flex items-center gap-1 text-sm text-gray-600">
                  <!-- loader mini -->
                  <svg
                    class="w-3 h-3 animate-spin"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.3" />
                    <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round" />
                  </svg>
                  <span>Procesando</span>
                </div>
              }
              @case ("completed") {
                <!-- Completado -->
                <span class="text-teal-600">Completado</span>
              }
              @case ("error") {
                <!-- Error -->
                <span class="text-red-600">Error</span>
              }
            }
          </td>
          <td><button class="text-red-600" (click)="remove(i)">‚úï</button></td>
          <td class="w-12 text-center">
            @if (p.report) {
              <button
                class="padding-1 bg-teal-600 text-white rounded hover:bg-teal-700 w-32 padding-10"
                (click)="openReport(p.report)"
              >
                Abrir reporte
              </button>
            }
          </td>
        </tr>
      }
    </tbody>
  </table>
}

<!-- Bot√≥n subir -->
<button
  class="mt-4 bg-teal-600 px-6 py-2 text-white rounded disabled:opacity-40"
  [disabled]="!canUpload()"
  (click)="uploadAll()"
>
  Subir todo
</button>

<!-- Modal reporte ZIP -->
@if (report()) {
  <div
    class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
    (click)="closeReport()"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 space-y-4"
      (click)="$event.stopPropagation()"
    >
      <h2 class="text-lg font-semibold">Resumen de ZIP</h2>

      <!-- Conteo -->
      <ul class="text-sm">
        <li>
          ‚úîÔ∏è Encolados: <b>{{ report()!.counts.enqueued }}</b>
        </li>
        <li>
          üîÑ Ya importados: <b>{{ report()!.counts.already_imported }}</b>
        </li>
        <li>
          ‚õî Inv√°lidos: <b>{{ report()!.counts.invalid_xml }}</b>
        </li>
      </ul>

      <!-- Tabla -->
      <div class="max-h-60 overflow-y-auto border-t pt-3 text-xs">
        <table class="w-full">
          <thead class="text-left">
            <tr>
              <th>Archivo</th>
              <th>Estatus</th>
            </tr>
          </thead>
          <tbody>
            @for (r of report()!.list; track r.file) {
              <tr class="border-b last:border-0">
                <td class="pr-2">{{ r.file }}</td>
                <td>
                  @switch (r.status) {
                    @case ("enqueued") {
                      <!-- Pendiente -->
                      <span class="text-teal-600">enqueued</span>
                    }
                    @case ("already_imported") {
                      <span class="text-yellow-600">duplicado</span>
                    }
                    @case ("invalid_xml") {
                      <span class="text-red-600">inv√°lido</span>
                    }
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <button
        class="mt-4 bg-teal-600 text-white px-4 py-1 rounded"
        (click)="closeReport()"
      >
        Cerrar
      </button>
    </div>
  </div>
}
