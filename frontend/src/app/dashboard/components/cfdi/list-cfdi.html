<section class="space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-xl font-semibold text-gray-800">CFDIs</h1>

    <div class="flex flex-wrap items-end gap-4">
      @if (uuidFilter()) {
        <button
          class="px-3 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 border border-gray-300"
          (click)="restoreList()"
        >
          Restaurar lista completa
        </button>
      }

      <!-- RFC Emisor (junto al título) -->
      <label
        class="flex items-center gap-2 text-sm text-gray-500"
        title="Buscar por RFC emisor"
      >
        <svg
          class="w-5 h-5 text-teal-700"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <circle
            cx="11"
            cy="11"
            r="7"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M21 21l-3.8-3.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <input
          type="text"
          class="border px-3 py-1.5 rounded-lg text-sm w-40 focus:ring-1 focus:ring-teal-500"
          placeholder="RFC Emisor"
          [value]="rfc()"
          (input)="rfc.set($any($event.target).value)"
        />
      </label>

      <!-- RFC Receptor -->
      <label
        class="flex items-center gap-2 text-sm text-gray-500"
        title="Buscar por RFC receptor"
      >
        <svg
          class="w-5 h-5 text-teal-700"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <circle
            cx="11"
            cy="11"
            r="7"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M21 21l-3.8-3.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <input
          type="text"
          class="border px-3 py-1.5 rounded-lg text-sm w-40 focus:ring-1 focus:ring-teal-500"
          placeholder="RFC receptor"
          [value]="rfcReceptor()"
          (input)="rfcReceptor.set($any($event.target).value)"
        />
      </label>

      <!-- reporte diot-->
      <button
        class="bg-teal-600 text-white px-3 py-2 rounded text-sm cursor-pointer"
        (click)="openDiotModal()"
      >
        Reporte DIOT
      </button>

      <!-- Fechas -->
      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2
                 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
          Desde
        </span>
        <input
          type="date"
          class="border px-2 py-1 rounded text-sm focus:ring-1 focus:ring-teal-500"
          [value]="desde()"
          (input)="desde.set($any($event.target).value)"
        />
      </label>

      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M16 17l-4 4m0 0l-4-4m4 4V3"
            />
          </svg>
          Hasta
        </span>
        <input
          type="date"
          class="border px-2 py-1 rounded text-sm focus:ring-1 focus:ring-teal-500"
          [value]="hasta()"
          (input)="hasta.set($any($event.target).value)"
        />
      </label>

      <!-- Status -->
      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 6h16M4 10h16M4 14h16M4 18h16"
            />
          </svg>
          Estatus
        </span>
        <select
          class="border px-2 py-1 rounded text-sm focus:ring-1 focus:ring-teal-500"
          [value]="status()"
          (change)="status.set($any($event.target).value)"
        >
          <option value="">Todos</option>
          <option value="PENDING">Pendiente</option>
          <option value="PROCESSING">Procesando</option>
          <option value="PARSED">Parseado</option>
        </select>
      </label>

      <!-- Total mínimo / máximo -->
      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <rect x="2" y="6" width="20" height="12" rx="2" ry="2" />
            <circle cx="12" cy="12" r="3" />
          </svg>
          Min
        </span>
        <input
          type="number"
          class="border px-2 py-1 rounded text-sm w-24 focus:ring-1 focus:ring-teal-500"
          [value]="totalMin()"
          (input)="totalMin.set($any($event.target).value)"
        />
      </label>

      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <rect x="2" y="6" width="20" height="12" rx="2" ry="2" />
            <circle cx="12" cy="12" r="3" />
          </svg>
          Max
        </span>
        <input
          type="number"
          class="border px-2 py-1 rounded text-sm w-24 focus:ring-1 focus:ring-teal-500"
          [value]="totalMax()"
          (input)="totalMax.set($any($event.target).value)"
        />
      </label>

      <!-- Límite -->
      <label class="flex flex-col text-xs text-gray-500">
        <span class="flex items-center gap-1 mb-0.5">
          <svg
            class="w-5 h-5 text-teal-700"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 6h16M4 10h16M4 14h16M4 18h16"
            />
          </svg>
          Límite
        </span>
        <select
          class="border px-2 py-1 rounded text-sm focus:ring-1 focus:ring-teal-500"
          [value]="limit()"
          (change)="limit.set($any($event.target).value)"
        >
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </label>
    </div>
  </div>

  <div class="overflow-x-auto rounded-lg shadow border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-left text-xs font-semibold text-gray-600">
        <tr>
          <th class="px-4 py-2">UUID</th>
          <th class="px-4 py-2">Fecha</th>
          <th class="px-4 py-2">Emisor</th>
          <th class="px-4 py-2">Receptor</th>
          <th class="px-4 py-2">Total</th>
          <th class="px-4 py-2 text-center">Acciones</th>
          <th class="px-4 py-2">Estado</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="7" class="text-center py-4 text-gray-500">
              Cargando...
            </td>
          </tr>
        } @else if (cfdis().length === 0) {
          <tr>
            <td colspan="7" class="text-center py-4 text-gray-400">
              No hay CFDIs
            </td>
          </tr>
        } @else {
          @for (cfdi of cfdis(); track cfdi.uuid) {
            <tr
              [ngClass]="{
                'bg-red-50': cfdi.uuidSustituto,
                'bg-green-50': cfdi.uuidSustituido,
              }"
              class="border-t hover:bg-gray-50 cursor-pointer"
              (click)="onRowClick(cfdi)"
            >
              <td class="px-4 py-2 font-mono text-xs">
                {{ cfdi.uuid }}
                @if (cfdi.uuidSustituto) {
                  <span
                    class="ml-1 px-1 py-0.5 rounded-full bg-red-100 text-red-700 text-[10px]"
                    title="Este CFDI fue sustituido"
                  >
                    sustituido
                  </span>
                }
                @if (cfdi.uuidSustituido && !cfdi.uuidSustituto) {
                  <span
                    class="ml-1 px-1 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px]"
                    title="Este CFDI sustituye a otro"
                  >
                    sustituto
                  </span>
                }
              </td>
              <td class="px-4 py-2">{{ cfdi.fecha }}</td>
              <td class="px-4 py-2">{{ cfdi.rfcEmisor }}</td>
              <td class="px-4 py-2">{{ cfdi.rfcReceptor }}</td>
              <td class="px-4 py-2">{{ cfdi.total }}</td>
              <td class="px-4 py-2 text-center flex gap-2 justify-center">
                <button
                  class="cursor-pointer inline-flex items-center gap-1 bg-teal-50 hover:bg-teal-100 text-teal-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors"
                  (click)="downloadXml($event, cfdi.uuid)"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M3 16v2a2 2 0 002 2h14a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  XML
                </button>
                <button
                  class="cursor-pointer inline-flex items-center gap-1 bg-red-50 hover:bg-red-100 text-red-700 hover:text-red-800 px-3 py-1 rounded-full text-sm font-medium transition-colors"
                  (click)="deleteCfdi($event, cfdi.uuid)"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m4 0H5m3-3h8
             a1 1 0 011 1v1H7V5a1 1 0 011-1z"
                    />
                  </svg>
                  Eliminar
                </button>
              </td>
              <td class="px-4 py-2">
                @switch (cfdi.status) {
                  @case ("PARSED") {
                    <span
                      class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs"
                      >PARSED</span
                    >
                  }
                  @case ("PROCESSING") {
                    <span
                      class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 text-xs"
                      >PROCESS</span
                    >
                  }
                  @case ("PENDING") {
                    <span
                      class="px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 text-xs"
                      >PENDING</span
                    >
                  }
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Controles de paginación -->
  <div class="flex items-center justify-between mt-4">
    <span class="text-sm text-gray-600">
      Página {{ page() }} de {{ totalPages() }} · Mostrando
      {{ cfdis().length }} / {{ total() }} registros
    </span>

    <div class="flex gap-1">
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="goBlock(-1)"
        [disabled]="page() === 1"
      >
        «
      </button>

      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="prevPage()"
        [disabled]="page() === 1"
      >
        ‹
      </button>

      @for (p of pages(); track p) {
        <button
          class="px-3 py-1 rounded hover:bg-teal-100"
          [ngClass]="{ 'bg-teal-600 text-white': p === page() }"
          (click)="goPage(p)"
        >
          {{ p }}
        </button>
      }

      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="nextPage()"
        [disabled]="page() === totalPages()"
      >
        ›
      </button>

      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="goBlock(1)"
        [disabled]="page() === totalPages()"
      >
        »
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="text-red-600 text-sm">{{ error() }}</div>
  }
</section>

<!-- ============ Modal Detalle CFDI ============ -->
@if (selectedCfdi()) {
  <div
    class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
    (click)="closeDetail()"
  >
    <div
      class="bg-white w-full max-w-3xl rounded-xl shadow-lg p-6 space-y-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-lg font-semibold">CFDI {{ selectedCfdi()!.uuid }}</h2>
          <p class="text-xs text-gray-500">
            Fecha: {{ selectedCfdi()!.fecha }} · Emisor:
            {{ selectedCfdi()!.rfcEmisor }} · Receptor:
            {{ selectedCfdi()!.rfcReceptor }}
          </p>
          @if (selectedCfdi()?.uuidSustituto) {
            <p class="text-xs mt-1">
              <span class="text-red-600">Sustituido por:&nbsp;</span>
              <a
                class="underline cursor-pointer"
                (click)="goToUuid(selectedCfdi()?.uuidSustituto)"
              >
                {{ selectedCfdi()?.uuidSustituto }}
              </a>
            </p>
          }
          @if (selectedCfdi()?.uuidSustituido) {
            <p class="text-xs mt-1">
              <span class="text-green-600">Sustituye a:&nbsp;</span>
              <a
                class="underline cursor-pointer"
                (click)="goToUuid(selectedCfdi()?.uuidSustituido)"
              >
                {{ selectedCfdi()?.uuidSustituido }}
              </a>
            </p>
          }
        </div>
        <button
          class="text-red-600 text-xl leading-none"
          (click)="closeDetail()"
        >
          ×
        </button>
      </div>

      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          Subtotal: <b>{{ selectedCfdi()!.subTotal | number: "1.2-2" }}</b>
        </div>
        <div>
          Descuento: <b>{{ selectedCfdi()!.descuento | number: "1.2-2" }}</b>
        </div>
        <div>
          Total:
          <b class="text-teal-700">{{
            selectedCfdi()!.total | number: "1.2-2"
          }}</b>
        </div>
        <div>
          Método: <b>{{ selectedCfdi()!.metodoPago ?? "—" }}</b>
        </div>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-medium mb-2">
          Conceptos ({{ selectedCfdi()!.concepts.length }})
        </h3>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-xs">
            <thead class="bg-gray-100 text-gray-600">
              <tr>
                <th class="px-2 py-1">Descripción</th>
                <th class="px-2 py-1 text-right">Cantidad</th>
                <th class="px-2 py-1 text-right">V.Unitario</th>
                <th class="px-2 py-1 text-right">Importe</th>
              </tr>
            </thead>
            <tbody>
              @for (c of selectedCfdi()!.concepts; track c.id) {
                <tr class="border-t">
                  <td class="px-2 py-1 align-top">
                    {{ c.descripcion }}
                    @if (c.taxes.length) {
                      <table class="mt-1 w-full text-[11px] bg-gray-50 rounded">
                        <thead class="text-gray-600">
                          <tr>
                            <th class="px-1 py-0.5">Imp.</th>
                            <th class="px-1 py-0.5 text-right">Tasa</th>
                            <th class="px-1 py-0.5 text-right">Base</th>
                            <th class="px-1 py-0.5 text-right">Importe</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (t of c.taxes; track t.id) {
                            <tr>
                              <td class="px-1 py-0.5">{{ t.impuesto }}</td>
                              <td class="px-1 py-0.5 text-right">
                                {{ (+t.tasaCuota).toFixed(2) }}%
                              </td>
                              <td class="px-1 py-0.5 text-right">
                                {{ (+t.base).toFixed(2) }}
                              </td>
                              <td class="px-1 py-0.5 text-right">
                                {{ (+t.importe).toFixed(2) }}
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    }
                  </td>
                  <td class="px-2 py-1 text-right">{{ c.cantidad }}</td>
                  <td class="px-2 py-1 text-right">
                    {{ (+c.valorUnitario).toFixed(2) }}
                  </td>
                  <td class="px-2 py-1 text-right">
                    {{ (+c.importe).toFixed(2) }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <div class="text-right">
        <button
          class="bg-teal-600 text-white px-4 py-1 rounded cursor-pointer hover:bg-teal-700 transition-colors"
          (click)="closeDetail()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
}

<!-- ============ Modal reporte DIOT ============ -->
@if (showDiot()) {
  <div
    class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
    (click)="closeDiot()"
  >
    <div
      class="bg-white w-full max-w-4xl rounded-xl p-6 shadow"
      (click)="$event.stopPropagation()"
    >
      <h1 class="text-xl font-semibold mb-4">Reporte DIOT</h1>

      <div class="flex gap-3 mb-4">
        <label class="text-sm"
          >Desde:
          <input
            type="date"
            class="border px-2 py-1 rounded"
            [value]="diotDesde()"
            (input)="diotDesde.set($any($event.target).value)"
          />
        </label>
        <label class="text-sm"
          >Hasta:
          <input
            type="date"
            class="border px-2 py-1 rounded"
            [value]="diotHasta()"
            (input)="diotHasta.set($any($event.target).value)"
          />
        </label>
        <button
          class="bg-teal-600 text-white px-4 py-1 rounded"
          (click)="reporteDiot()"
        >
          Generar
        </button>
      </div>

      @if (diotLoading()) {
        <p>Cargando…</p>
      } @else if (rows().length) {
        <div class="overflow-x-auto">
          <table class="text-sm w-full border">
            <thead class="bg-gray-100 text-xs">
              <tr>
                <th class="px-2 py-1">RFC Receptor</th>
                <th class="px-2 py-1">Tipo</th>
                <th class="px-2 py-1">Impuesto</th>
                <th class="px-2 py-1 text-right">Base</th>
                <th class="px-2 py-1 text-right">Importe</th>
              </tr>
            </thead>
            <tbody>
              @for (r of rows(); track r.rfcReceptor + r.impuesto) {
                <tr class="border-t">
                  <td class="px-2 py-1">{{ r.rfcReceptor }}</td>
                  <td class="px-2 py-1">{{ r.tipo }}</td>
                  <td class="px-2 py-1">{{ r.impuesto }}</td>
                  <td class="px-2 py-1 text-right">
                    {{ r.base | number: "1.2-2" }}
                  </td>
                  <td class="px-2 py-1 text-right">
                    {{ r.importe | number: "1.2-2" }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <p class="text-gray-500">Sin resultados en el rango seleccionado.</p>
      }

      @if (diotError()) {
        <p class="text-red-600">{{ diotError() }}</p>
      }

      <div class="text-right mt-4">
        <button
          class="bg-teal-600 text-white px-4 py-1 rounded"
          (click)="closeDiot()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
}
