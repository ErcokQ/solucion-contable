<section class="space-y-6">
  <!-- Filtros -->
  <div class="flex flex-wrap gap-3 items-end">
    <label class="text-sm">
      Desde
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="fechaDesde()"
        (input)="fechaDesde.set($any($event.target).value)"
      />
    </label>

    <label class="text-sm">
      Hasta
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="fechaHasta()"
        (input)="fechaHasta.set($any($event.target).value)"
      />
    </label>

    <select
      class="border px-2 py-1 rounded text-sm"
      [value]="tipo()"
      (change)="tipo.set($any($event.target).value)"
    >
      <option value="emitidos">Emitidos</option>
      <option value="recibidos">Recibidos</option>
    </select>

    <input
      placeholder="RFC de la empresa"
      class="border px-2 py-1 rounded text-sm uppercase"
      [value]="rfc()"
      (input)="rfc.set($any($event.target).value.trim().toUpperCase())"
    />

    <select
      class="border px-2 py-1 rounded text-sm"
      [value]="origen()"
      (change)="origen.set($any($event.target).value)"
    >
      <option value="todos">Todos</option>
      <option value="factura">Sólo factura</option>
      <option value="nomina">Sólo nómina</option>
    </select>

    <label class="text-sm flex gap-1 items-center">
      <input
        type="checkbox"
        [checked]="agruparGlobal()"
        (change)="agruparGlobal.set($any($event.target).checked)"
      />
      Agrupar global
    </label>

    <button class="bg-teal-600 text-white px-4 py-1 rounded" (click)="fetch()">
      Buscar
    </button>

    <button
      class="bg-amber-500 text-white px-4 py-1 rounded flex items-center gap-1"
      (click)="exportXlsx()"
      [disabled]="rows().length === 0"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"
        />
      </svg>
      XLSX
    </button>
  </div>

  <!-- Tabla -->
  <div class="overflow-x-auto rounded-lg shadow border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-xs text-gray-600 text-left">
        <tr>
          <th class="px-3 py-2">RFC Contraparte</th>
          <th class="px-3 py-2 text-right">Subtotal</th>
          <th class="px-3 py-2 text-right">Descuento</th>
          <th class="px-3 py-2 text-right">Total</th>
          <th class="px-3 py-2 text-right">IVA</th>
          <th class="px-3 py-2 text-right">CFDI</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-500">
              Cargando…
            </td>
          </tr>
        } @else if (rows().length === 0) {
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-400">
              Sin resultados
            </td>
          </tr>
        } @else {
          @for (r of rows(); track r.rfcContraparte) {
            <tr class="border-t hover:bg-gray-50">
              <td class="px-3 py-1 font-mono text-xs">
                {{ r.rfcContraparte }}
              </td>
              <td class="px-3 py-1 text-right">{{ r.subtotal }}</td>
              <td class="px-3 py-1 text-right">{{ r.descuento }}</td>
              <td class="px-3 py-1 text-right">{{ r.total }}</td>
              <td class="px-3 py-1 text-right">{{ r.iva }}</td>
              <td class="px-3 py-1 text-right">{{ r.cantidad }}</td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  @if (error()) {
    <p class="text-red-600 text-sm">{{ error() }}</p>
  }
</section>
