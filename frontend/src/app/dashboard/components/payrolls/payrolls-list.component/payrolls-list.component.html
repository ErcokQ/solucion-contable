<section class="space-y-6">
  <div class="text-2xl font-semibold text-gray-800">Complementos de Nómina</div>
  <!-- ░░░  Filtros  ░░░ -->
  <div class="flex flex-wrap gap-4 items-end">
    <label class="text-xs text-gray-600"
      >RFC Receptor
      <input
        type="text"
        class="border px-3 py-1.5 rounded text-sm w-44"
        [value]="rfc()"
        (input)="rfc.set($any($event.target).value)"
      />
    </label>

    <label class="text-xs text-gray-600"
      >Desde
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="desde()"
        (input)="desde.set($any($event.target).value)"
      />
    </label>

    <label class="text-xs text-gray-600"
      >Hasta
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="hasta()"
        (input)="hasta.set($any($event.target).value)"
      />
    </label>

    <label class="text-xs text-gray-600"
      >Tipo
      <select
        class="border px-2 py-1 rounded text-sm"
        [value]="tipo()"
        (change)="tipo.set($any($event.target).value)"
      >
        <option value="">Todos</option>
        <option value="O">Ordinaria</option>
        <option value="E">Extraordinaria</option>
      </select>
    </label>

    <label class="text-xs text-gray-600"
      >Límite
      <select
        class="border px-2 py-1 rounded text-sm"
        [value]="limit()"
        (change)="limit.set($any($event.target).value)"
      >
        <option>10</option>
        <option>25</option>
        <option>50</option>
        <option>100</option>
      </select>
    </label>
  </div>

  <!-- ░░░  Tabla Nóminas  ░░░ -->
  <div class="overflow-x-auto border rounded-lg bg-white shadow">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-xs text-gray-600">
        <tr>
          <th class="px-4 py-2">ID</th>
          <th class="px-4 py-2">Fecha Pago</th>
          <th class="px-4 py-2">RFC Receptor</th>
          <th class="px-4 py-2 text-right">Percepciones</th>
          <th class="px-4 py-2 text-right">Deducciones</th>
          <th class="px-4 py-2 text-center">Tipo</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="6" class="text-center py-4">Cargando…</td>
          </tr>
        } @else if (rows().length === 0) {
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-500">
              Sin resultados
            </td>
          </tr>
        } @else {
          @for (n of rows(); track n.id) {
            <tr
              class="border-t hover:bg-gray-50 cursor-pointer text-center"
              (click)="open(n)"
            >
              <td class="px-4 py-1">{{ n.id }}</td>
              <td class="px-4 py-1">{{ n.fechaPago }}</td>
              <td class="px-4 py-1">{{ n.rfcReceptor }}</td>
              <td class="px-4 py-1 text-right">
                {{ n.totalPercepciones | number: "1.2-2" }}
              </td>
              <td class="px-4 py-1 text-right">
                {{ n.totalDeducciones | number: "1.2-2" }}
              </td>
              <td class="px-4 py-1 text-center">{{ n.tipoNomina }}</td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- ░░░  Paginación  ░░░ -->
  <div class="flex justify-between items-center mt-4 text-sm">
    <span>Página {{ page() }} de {{ totalPages() }}</span>
    <div class="flex gap-1">
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
        (click)="prev()"
        [disabled]="page() === 1"
      >
        ‹
      </button>
      @for (p of pages(); track p) {
        <button
          class="px-3 py-1 rounded hover:bg-teal-100"
          [ngClass]="{ 'bg-teal-600 text-white': p === page() }"
          (click)="go(p)"
        >
          {{ p }}
        </button>
      }
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
        (click)="next()"
        [disabled]="page() === totalPages()"
      >
        ›
      </button>
    </div>
  </div>

  <!-- ░░░  Modal Detalle  ░░░ -->
  @if (selected()) {
    <div
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
      (click)="close()"
    >
      <div
        class="bg-white w-full max-w-4xl rounded-xl p-6 shadow space-y-5"
        (click)="$event.stopPropagation()"
      >
        <!-- header -->
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-lg font-semibold">Nómina #{{ selected()!.id }}</h2>
            <p class="text-xs text-gray-500">
              Pago: {{ selected()!.fechaPago }} · RFC:
              {{ selected()!.rfcReceptor }}
            </p>
          </div>
          <button class="text-xl text-red-600 leading-none" (click)="close()">
            ×
          </button>
        </div>

        <div class="text-sm">
          CFDI:
          <a
            [routerLink]="['/dashboard/cfdis']"
            [queryParams]="{ rfc: selected()!.rfcReceptor }"
            class="text-teal-600 underline inline-flex items-center gap-1"
          >
            {{ selected()!.cfdiUuid }}
            <svg
              class="w-3 h-3"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M14 3h7m0 0v7m0-7L10 14"
              />
            </svg>
          </a>
        </div>

        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            Tipo: <b>{{ selected()!.tipoNomina }}</b>
          </div>
          <div>
            Días pagados: <b>{{ selected()!.diasPagados }}</b>
          </div>
          <div>
            Percepciones:
            <b>{{ selected()!.totalPercepciones | number: "1.2-2" }}</b>
          </div>
          <div>
            Deducciones:
            <b>{{ selected()!.totalDeducciones | number: "1.2-2" }}</b>
          </div>
          <div>
            Otros pagos:
            <b>{{ selected()!.totalOtrosPagos | number: "1.2-2" }}</b>
          </div>
        </div>

        <!-- percepciones -->
        <div class="border-t pt-3">
          <h3 class="font-medium mb-1">
            Percepciones ({{ selected()!.percepciones.length }})
          </h3>
          <div class="max-h-56 overflow-y-auto">
            <table class="w-full text-xs">
              <thead class="bg-gray-100 text-gray-600">
                <tr>
                  <th class="px-1">Clave</th>
                  <th>Concepto</th>
                  <th class="text-right px-1">Gravado</th>
                  <th class="text-right px-1">Exento</th>
                </tr>
              </thead>
              <tbody>
                @for (p of selected()!.percepciones; track p.id) {
                  <tr class="border-t">
                    <td class="px-1">{{ p.clave }}</td>
                    <td class="px-1">{{ p.concepto }}</td>
                    <td class="px-1 text-right">
                      {{ p.importeGravado | number: "1.2-2" }}
                    </td>
                    <td class="px-1 text-right">
                      {{ p.importeExento | number: "1.2-2" }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <!-- deducciones -->
        <div class="border-t pt-3">
          <h3 class="font-medium mb-1">
            Deducciones ({{ selected()!.deducciones.length }})
          </h3>
          <div class="max-h-48 overflow-y-auto">
            <table class="w-full text-xs">
              <thead class="bg-gray-100 text-gray-600">
                <tr>
                  <th class="px-1">Clave</th>
                  <th>Concepto</th>
                  <th class="text-right px-1">Importe</th>
                </tr>
              </thead>
              <tbody>
                @for (d of selected()!.deducciones; track d.id) {
                  <tr class="border-t">
                    <td class="px-1">{{ d.clave }}</td>
                    <td class="px-1">{{ d.concepto }}</td>
                    <td class="px-1 text-right">
                      {{ d.importe | number: "1.2-2" }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <!-- otros pagos -->
        <div class="border-t pt-3" *ngIf="selected()!.otrosPagos.length">
          <h3 class="font-medium mb-1">
            Otros pagos ({{ selected()!.otrosPagos.length }})
          </h3>
          <div class="max-h-48 overflow-y-auto">
            <table class="w-full text-xs">
              <thead class="bg-gray-100 text-gray-600">
                <tr>
                  <th class="px-1">Clave</th>
                  <th>Concepto</th>
                  <th class="text-right px-1">Importe</th>
                </tr>
              </thead>
              <tbody>
                @for (o of selected()!.otrosPagos; track o.id) {
                  <tr class="border-t">
                    <td class="px-1">{{ o.clave }}</td>
                    <td class="px-1">{{ o.concepto }}</td>
                    <td class="px-1 text-right">
                      {{ o.importe | number: "1.2-2" }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <div class="text-right">
          <button
            class="bg-teal-600 text-white px-4 py-1 rounded"
            (click)="close()"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }
</section>
