<section class="space-y-6">
  <div class="text-2xl font-semibold text-gray-800">Complementos de pago</div>
  @if (paymentId() !== null) {
    <button
      class="px-3 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 border border-gray-300"
      (click)="restoreList()"
    >
      Restaurar lista completa
    </button>
  }

  <!------- filtros ------->
  <div class="flex flex-wrap gap-4 items-end">
    <label class="flex flex-col text-xs text-gray-500">
      <span>RFC Receptor</span>
      <input
        type="text"
        class="border px-3 py-1.5 rounded text-sm w-44"
        [value]="rfc()"
        (input)="rfc.set($any($event.target).value)"
      />
    </label>

    <label class="flex flex-col text-xs text-gray-500">
      <span>Desde</span>
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="desde()"
        (input)="desde.set($any($event.target).value)"
      />
    </label>

    <label class="flex flex-col text-xs text-gray-500">
      <span>Hasta</span>
      <input
        type="date"
        class="border px-2 py-1 rounded text-sm"
        [value]="hasta()"
        (input)="hasta.set($any($event.target).value)"
      />
    </label>

    <label class="flex flex-col text-xs text-gray-500">
      <span>Límite</span>
      <select
        class="border px-2 py-1 rounded text-sm"
        [value]="limit()"
        (change)="limit.set($any($event.target).value)"
      >
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>
  </div>

  <!------- tabla ------->
  <div class="overflow-x-auto border rounded-lg bg-white shadow">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-xs text-gray-600">
        <tr>
          <th class="px-4 py-2">ID</th>
          <th class="px-4 py-2">Fecha</th>
          <th class="px-4 py-2">RFC Receptor</th>
          <th class="px-4 py-2 text-right">Monto</th>
          <th class="px-4 py-2 text-center">Forma</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="5" class="text-center py-4">Cargando…</td>
          </tr>
        } @else if (rows().length === 0) {
          <tr>
            <td colspan="5" class="text-center py-4 text-gray-500">
              Sin resultados
            </td>
          </tr>
        } @else {
          @for (p of rows(); track p.id) {
            <tr
              class="border-t hover:bg-gray-50 cursor-pointer text-center"
              (click)="openDetail(p)"
            >
              <td class="px-4 py-1">{{ p.id }}</td>
              <td class="px-4 py-1">{{ p.fechaPago }}</td>
              <td class="px-4 py-1">{{ p.rfcReceptor }}</td>
              <td class="px-4 py-1 text-right">
                {{ p.monto | number: "1.2-2" }} {{ p.moneda }}
              </td>
              <td class="px-4 py-1 text-center">{{ p.formaPago || "—" }}</td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!------- paginación ------->
  <div class="flex justify-between items-center mt-4 text-sm">
    <span>Página {{ page() }} de {{ totalPages() }}</span>

    <div class="flex gap-1">
      <!-- bloque anterior (20 páginas atrás) -->
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="goBlock(-1)"
        [disabled]="page() === 1"
      >
        «
      </button>

      <!-- página anterior -->
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="prev()"
        [disabled]="page() === 1"
      >
        ‹
      </button>

      @for (p of pages(); track p) {
        <button
          class="px-3 py-1 rounded hover:bg-teal-100"
          [ngClass]="{ 'bg-teal-600 text-white': p === page() }"
          (click)="go(p)"
        >
          {{ p }}
        </button>
      }

      <!-- página siguiente -->
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="next()"
        [disabled]="page() === totalPages()"
      >
        ›
      </button>

      <!-- bloque siguiente (20 páginas adelante) -->
      <button
        class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40"
        (click)="goBlock(1)"
        [disabled]="page() === totalPages()"
      >
        »
      </button>
    </div>
  </div>

  <!------- modal detalle ------->
  @if (selected()) {
    <div
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
      (click)="closeDetail()"
    >
      <div
        class="bg-white w-full max-w-3xl rounded-xl p-6 shadow space-y-5"
        (click)="$event.stopPropagation()"
      >
        <!-- Encabezado -->
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-lg font-semibold">Pago #{{ selected()!.id }}</h2>
            <p class="text-xs text-gray-500">
              Fecha: {{ selected()!.fechaPago }}
            </p>
          </div>
          <button
            class="text-xl text-red-600 leading-none"
            (click)="closeDetail()"
          >
            ×
          </button>
        </div>

        <!-- Resumen -->
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            RFC Receptor: <b>{{ selected()!.cfdiHeader.rfcReceptor }}</b>
          </div>
          <div>
            RFC Emisor: <b>{{ selected()!.cfdiHeader.rfcEmisor }}</b>
          </div>
          <div>
            Monto:
            <b>
              {{ selected()!.monto | number: "1.2-2" }}
              {{ selected()!.moneda }}
            </b>
          </div>
          <div>
            Forma: <b>{{ selected()!.formaPago }}</b>
          </div>
          <div *ngIf="selected()!.tipoCambio">
            Tipo de cambio: <b>{{ selected()!.tipoCambio }}</b>
          </div>
          <div>
            Total CFDI:
            <b>{{ selected()!.cfdiHeader.total | number: "1.2-2" }}</b>
          </div>
        </div>

        <!-- UUID CFDI con enlace -->
        <div class="text-sm">
          CFDI:
          <a
            [routerLink]="['/dashboard/cfdis']"
            [queryParams]="{ uuid: selected()!.cfdiHeader.uuid }"
            class="text-teal-600 underline inline-flex items-center gap-1"
          >
            {{ selected()!.cfdiHeader.uuid }}
            <svg
              class="w-3 h-3"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M14 3h7m0 0v7m0-7L10 14"
              />
            </svg>
          </a>
        </div>

        <!-- Detalles -->
        <div class="border-t pt-4">
          <h3 class="font-medium mb-2">
            Aplicaciones ({{ selected()!.detalles.length }})
          </h3>
          <div class="max-h-60 overflow-y-auto">
            <table class="w-full text-xs">
              <thead class="bg-gray-100 text-gray-600">
                <tr>
                  <th class="px-1">UUID Rel.</th>
                  <th class="px-1 text-right">Pagado</th>
                  <th class="px-1 text-right">Saldo Ant.</th>
                  <th class="px-1 text-right">Saldo Insol.</th>
                </tr>
              </thead>
              <tbody>
                @for (d of selected()!.detalles; track d.uuidRelacionado) {
                  <tr class="border-t">
                    <td class="px-1">{{ d.uuidRelacionado }}</td>
                    <td class="px-1 text-right">
                      {{ d.importePagado | number: "1.2-2" }}
                    </td>
                    <td class="px-1 text-right">
                      {{ d.saldoAnterior | number: "1.2-2" }}
                    </td>
                    <td class="px-1 text-right">
                      {{ d.saldoInsoluto | number: "1.2-2" }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <div class="text-right">
          <button
            class="bg-teal-600 text-white px-4 py-1 rounded"
            (click)="closeDetail()"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }
</section>
