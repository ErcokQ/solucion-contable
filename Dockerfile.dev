# ------------------------------------------------------------------
# Imagen DEV â€“ ejecuta .ts con ts-node-dev + hot-reload
# ------------------------------------------------------------------
FROM node:22.16-alpine

# Java para xsd-schema-validator
RUN apk add --no-cache openjdk17-jdk dos2unix \
    && ln -s /usr/lib/jvm/default-jvm /usr/lib/jvm/java-17-openjdk

WORKDIR /home/app

# deps (incluyendo devDependencies)
COPY package*.json ./
RUN npm ci

# cÃ³digo + utilidades
COPY tsconfig.json ./
COPY src ./src
COPY docs ./docs
COPY scripts/wait-for.sh /usr/local/bin/wait-for
RUN dos2unix /usr/local/bin/wait-for && chmod +x /usr/local/bin/wait-for   # ðŸ†• convierte a LF

# vars por defecto
ENV NODE_ENV=development \
    PORT=3000 \
    DB_HOST=mysql \
    DB_PORT=3306 \
    REDIS_HOST=redis

# arranque:
# â‘  espera MySQL
# â‘¡ corre migraciones en .ts
# â‘¢ lanza API con recarga
CMD ["sh", "-c", \
  "wait-for mysql:3306 -- npm run mig:run && npm run dev"]
